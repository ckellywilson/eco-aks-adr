parameters:
  - name: terraformPath
    type: string
    displayName: 'Terraform working directory'
  - name: serviceConnection
    type: string
    displayName: 'Azure DevOps Service Connection name'

steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: 'latest'

  - task: AzureCLI@2
    displayName: 'Run Terraform Format Check'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        cd "${{ parameters.terraformPath }}"
        echo "üîç Running Terraform Format Check..."
        terraform fmt -check -recursive
        if [ $? -eq 0 ]; then
          echo "‚úÖ Terraform format is valid"
        else
          echo "‚ùå Terraform files need formatting. Run: terraform fmt -recursive"
          exit 1
        fi

  - task: AzureCLI@2
    displayName: 'Run Terraform Validate'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        cd "${{ parameters.terraformPath }}"
        echo "üîç Running Terraform Validate..."
        terraform init -backend=false -input=false
        terraform validate
        if [ $? -eq 0 ]; then
          echo "‚úÖ Terraform configuration is valid"
        else
          echo "‚ùå Terraform validation failed"
          exit 1
        fi

  - task: bash@3
    displayName: 'Run TFSec Security Scan'
    inputs:
      targetType: 'inline'
      script: |
        cd "${{ parameters.terraformPath }}"
        echo "üîç Running TFSec Security Scan..."
        if command -v tfsec &> /dev/null; then
          tfsec . --minimum-severity MEDIUM --format sarif > /tmp/tfsec.sarif 2>&1 || {
            echo "‚ö†Ô∏è  TFSec found issues with medium or higher severity"
            cat /tmp/tfsec.sarif
            exit 1
          }
          echo "‚úÖ TFSec scan completed with no violations"
        else
          echo "‚ö†Ô∏è  TFSec not installed, skipping security scan"
        fi
    continueOnError: false
