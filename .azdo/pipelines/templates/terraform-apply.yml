parameters:
  - name: terraformPath
    type: string
    displayName: 'Terraform working directory'
  - name: planFile
    type: string
    displayName: 'Terraform plan file'
  - name: serviceConnection
    type: string
    displayName: 'Azure DevOps Service Connection name'

steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: 'latest'

  - task: AzureCLI@2
    displayName: 'Terraform Apply'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e
        cd "${{ parameters.terraformPath }}"
        
        if [ ! -f "${{ parameters.planFile }}" ]; then
          echo "‚ùå Plan file not found: ${{ parameters.planFile }}"
          exit 1
        fi
        
        echo "üöÄ Applying Terraform configuration..."
        terraform apply \
          -input=false \
          -auto-approve \
          ${{ parameters.planFile }}
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Terraform apply completed successfully"
          terraform output -json > outputs.json 2>/dev/null || true
        else
          echo "‚ùå Terraform apply failed"
          exit 1
        fi
    env:
      TF_INPUT: false
      TF_IN_AUTOMATION: true
      ARM_USE_AZUREAD: true

  - task: PublishBuildArtifacts@1
    condition: always()
    inputs:
      PathtoPublish: '${{ parameters.terraformPath }}/outputs.json'
      ArtifactName: 'terraform-outputs'
      publishLocation: 'Container'
    displayName: 'Publish Terraform Outputs'
    continueOnError: true
