parameters:
  - name: terraformPath
    type: string
    displayName: 'Terraform working directory'
  - name: tfvarsFile
    type: string
    displayName: 'Terraform variables file'
  - name: planFile
    type: string
    displayName: 'Output plan file name'
  - name: serviceConnection
    type: string
    displayName: 'Azure DevOps Service Connection name'

steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: 'latest'

  - task: AzureCLI@2
    displayName: 'Terraform Plan'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e
        cd "${{ parameters.terraformPath }}"
        
        echo "üìã Generating Terraform plan..."
        terraform plan \
          -var-file="${{ parameters.tfvarsFile }}" \
          -out=${{ parameters.planFile }} \
          -input=false \
          -detailed-exitcode || PLAN_EXIT=$?
        
        case "$PLAN_EXIT" in
          0)
            echo "‚ÑπÔ∏è  No changes detected"
            ;;
          1)
            echo "‚ùå Terraform plan encountered an error"
            exit 1
            ;;
          2)
            echo "üìä Changes detected - plan saved to ${{ parameters.planFile }}"
            ;;
          *)
            echo "‚ö†Ô∏è  Unknown exit code: $PLAN_EXIT"
            ;;
        esac
    env:
      TF_INPUT: false
      TF_IN_AUTOMATION: true
      ARM_USE_AZUREAD: true

  - task: PublishBuildArtifacts@1
    condition: always()
    inputs:
      PathtoPublish: '${{ parameters.terraformPath }}/${{ parameters.planFile }}'
      ArtifactName: 'terraform-plans'
      publishLocation: 'Container'
    displayName: 'Publish Terraform Plan'
