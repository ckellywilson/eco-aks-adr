# Azure DevOps Pipeline for Spoke AKS Terraform Deployment
# File: azure-pipelines-spoke.yml
# Location: Repository root
# This pipeline handles ONLY spoke infrastructure deployment with OIDC authentication
# IMPORTANT: Hub infrastructure must be deployed successfully BEFORE running this pipeline
# Hub infrastructure is in a separate pipeline: azure-pipelines-hub.yml

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - infra/terraform/spoke-aks-prod/**
      - azure-pipelines-spoke.yml

variables:
  terraform_version: 1.10.5
  # Set these in ADO Pipeline Variables:
  # - AZURE_SUBSCRIPTION_ID: Your subscription ID
  # - AZURE_TENANT_ID: Your Azure tenant ID
  # - AZURE_CLIENT_ID: Workload Identity service principal client ID

stages:
  - stage: Validate
    displayName: Validate Spoke Terraform Code
    jobs:
      - job: ValidateSpoke
        displayName: Validate Spoke Configuration
        steps:
          - checkout: self

          - task: TerraformInstaller@0
            inputs:
              terraformVersion: $(terraform_version)

          - task: TerraformTaskV4@4
            inputs:
              command: 'init'
              workingDirectory: 'infra/terraform/spoke-aks-prod'
              backendServiceArm: 'azure-hub-prod'
              backendAzureRmResourceGroupName: 'rg-terraform-state-dev'
              backendAzureRmStorageAccountName: 'sttfstatedevd3120d7a'
              backendAzureRmContainerName: 'terraform-state-dev'
              backendAzureRmKey: 'spoke-aks-prod/terraform.tfstate'
              commandOptions: '-backend-config="use_oidc=true"'
            env:
              ARM_USE_OIDC: 'true'
              ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
              ARM_TENANT_ID: $(AZURE_TENANT_ID)

          - task: TerraformTaskV4@4
            inputs:
              command: 'validate'
              workingDirectory: 'infra/terraform/spoke-aks-prod'

  - stage: PlanSpoke
    displayName: Plan Spoke Infrastructure
    dependsOn: Validate
    condition: succeeded()
    jobs:
      - job: PlanSpokeJob
        displayName: Terraform Plan - Spoke
        steps:
          - checkout: self

          - task: TerraformInstaller@0
            inputs:
              terraformVersion: $(terraform_version)

          - task: TerraformTaskV4@4
            inputs:
              command: 'init'
              workingDirectory: 'infra/terraform/spoke-aks-prod'
              backendServiceArm: 'azure-hub-prod'
              backendAzureRmResourceGroupName: 'rg-terraform-state-dev'
              backendAzureRmStorageAccountName: 'sttfstatedevd3120d7a'
              backendAzureRmContainerName: 'terraform-state-dev'
              backendAzureRmKey: 'spoke-aks-prod/terraform.tfstate'
              commandOptions: '-backend-config="use_oidc=true"'
            env:
              ARM_USE_OIDC: 'true'
              ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
              ARM_TENANT_ID: $(AZURE_TENANT_ID)

          - task: DownloadSecureFile@1
            displayName: Download prod.tfvars from Secure Files
            inputs:
              secureFile: 'prod.tfvars'
              retryCount: '5'

          - task: TerraformTaskV4@4
            inputs:
              command: 'plan'
              workingDirectory: 'infra/terraform/spoke-aks-prod'
              commandOptions: '-var-file=$(Agent.TempDirectory)/prod.tfvars -var="subscription_id=$(AZURE_SUBSCRIPTION_ID)" -out=tfplan.prod'
            env:
              ARM_USE_OIDC: 'true'
              ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
              ARM_TENANT_ID: $(AZURE_TENANT_ID)

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'infra/terraform/spoke-aks-prod/tfplan.prod'
              ArtifactName: 'spoke-tfplan'

  - stage: ApplySpoke
    displayName: Apply Spoke Infrastructure
    dependsOn: PlanSpoke
    condition: succeeded()
    jobs:
      - deployment: ApplySpokeJob
        displayName: Terraform Apply - Spoke
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: TerraformInstaller@0
                  inputs:
                    terraformVersion: $(terraform_version)

                - task: DownloadBuildArtifacts@1
                  inputs:
                    buildType: 'current'
                    downloadType: 'specific'
                    itemPattern: 'spoke-tfplan/**'
                    downloadPath: '$(System.DefaultWorkingDirectory)'

                - task: TerraformTaskV4@4
                  inputs:
                    command: 'init'
                    workingDirectory: 'infra/terraform/spoke-aks-prod'
                    backendServiceArm: 'azure-hub-prod'
                    backendAzureRmResourceGroupName: 'rg-terraform-state-dev'
                    backendAzureRmStorageAccountName: 'sttfstatedevd3120d7a'
                    backendAzureRmContainerName: 'terraform-state-dev'
                    backendAzureRmKey: 'spoke-aks-prod/terraform.tfstate'
                    commandOptions: '-backend-config="use_oidc=true"'
                  env:
                    ARM_USE_OIDC: 'true'
                    ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
                    ARM_TENANT_ID: $(AZURE_TENANT_ID)

                - task: TerraformTaskV4@4
                  inputs:
                    command: 'apply'
                    workingDirectory: 'infra/terraform/spoke-aks-prod'
                    commandOptions: '$(System.DefaultWorkingDirectory)/spoke-tfplan/tfplan.prod'
                  env:
                    ARM_USE_OIDC: 'true'
                    ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
                    ARM_TENANT_ID: $(AZURE_TENANT_ID)
